# Rendered: <%= Time.now.utc %>

# Redirect to WWW on production
<%= render "#{modules_path}/redirect-to-www-production.erb" , binding %>

server {

	##################################
	#                                #
	#        Default settings        #
	#                                #
	##################################

	# Error Logging
	error_log /var/log/nginx/error.log notice;
	# rewrite_log on;

	# Set the port
	listen 8080;

	# Where are we located? What should we load by default?
	root <%= app_deploy_to %>/current/public;
	index index.php index.html index.htm;

	# What's our domain name?
	<% if app_stage == "production" %>
	server_name www.<%= app_domain %>;
	<% else %>
	server_name <%= app_domain %>;
	<% end %>

	# Avoid sendfile issues with sending stale files
	# More: <http://www.vanpattenmedia.com/2012/a-tale-of-stale-content/>
	sendfile off;

	# Lockdown TimThumb
	<%= render "#{modules_path}/timthumb-lockdown.erb" , binding %>


	##################################
	#                                #
	#   Rewrites and asset caching   #
	#                                #
	##################################

	location / {
		try_files $uri $uri/ @rewrites;
	}

	location @rewrites {
		rewrite ^/plugins/(.*)$ /content/plugins/$1 last;

		# If nothing matches, send it to index.php
		rewrite ^ /index.php last;
	}


	###################
	#      Fonts      #
	###################

	<%= render "#{modules_path}/fonts.erb" , binding %>


	###################
	#      Images     #
	###################

	<%= render "#{modules_path}/images.erb" , binding %>


	###################
	#     CSS & JS    #
	###################

	<%= render "#{modules_path}/css-quickassets.erb" , binding %>


	##################################
	#                                #
	#         Error handling         #
	#                                #
	##################################

	# redirect server error pages to the static page /50x.html
	# error_page 404 /404.html;
	# error_page 500 502 503 504 /50x.html;
	# location = /50x.html {
	# 	root /usr/share/nginx/www;
	# }

	<%= render "#{modules_path}/default-deny.erb" , binding %>


	##################################
	#                                #
	#      PHP-related settings      #
	#                                #
	##################################

	<%= render "#{modules_path}/php-fpm.erb" , binding %>
}
